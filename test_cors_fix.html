<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CORS Fix Test - ReWear</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background: #202f4a;
        color: white;
      }
      .test-section {
        background: white;
        color: #202f4a;
        padding: 20px;
        margin: 20px 0;
        border-radius: 10px;
      }
      .success {
        color: green;
        font-weight: bold;
      }
      .error {
        color: red;
        font-weight: bold;
      }
      .warning {
        color: orange;
        font-weight: bold;
      }
      button {
        background: #4caf50;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background: #45a049;
      }
      .log {
        background: #f5f5f5;
        border: 1px solid #ddd;
        padding: 10px;
        margin: 10px 0;
        border-radius: 5px;
        font-family: monospace;
        max-height: 200px;
        overflow-y: auto;
      }
    </style>
  </head>
  <body>
    <h1>üîß CORS Fix Test</h1>

    <div class="test-section">
      <h2>Test Event Creation (CORS Fixed)</h2>
      <p>
        This test will create an event with a file upload to verify the CORS fix
        is working.
      </p>

      <input
        type="file"
        id="testImage"
        accept="image/*"
        style="margin: 10px 0"
      />
      <br />
      <button onclick="testEventWithFile()">
        Test Event Creation with File
      </button>
      <button onclick="testEventWithoutFile()">
        Test Event Creation without File
      </button>

      <div id="testResult" style="margin-top: 10px"></div>
    </div>

    <div class="test-section">
      <h2>Test Results</h2>
      <div id="testLog" class="log"></div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <script src="js/firebase.js"></script>

    <script>
      function log(message, type = "info") {
        const logDiv = document.getElementById("testLog");
        const timestamp = new Date().toLocaleTimeString();
        const color =
          type === "error"
            ? "red"
            : type === "success"
            ? "green"
            : type === "warning"
            ? "orange"
            : "blue";
        logDiv.innerHTML += `<div style="color: ${color};">[${timestamp}] ${message}</div>`;
        logDiv.scrollTop = logDiv.scrollHeight;
      }

      // Test event creation with file
      async function testEventWithFile() {
        const fileInput = document.getElementById("testImage");
        const file = fileInput.files[0];
        const resultDiv = document.getElementById("testResult");

        if (!file) {
          resultDiv.innerHTML =
            '<span class="warning">‚ö†Ô∏è Please select a file first</span>';
          return;
        }

        if (!window.auth.currentUser) {
          log("Signing in anonymously...", "info");
          try {
            await window.auth.signInAnonymously();
            log("Anonymous sign in successful", "success");
          } catch (error) {
            log(`Sign in failed: ${error.message}`, "error");
            return;
          }
        }

        log("Starting event creation test with file...", "info");
        resultDiv.innerHTML =
          '<span class="warning">‚è≥ Creating event...</span>';

        try {
          const eventId = window.db.ref("events").push().key;
          log(`Generated event ID: ${eventId}`, "info");

          let posterUrl = "";

          // Try Firebase Storage first
          try {
            log("Attempting Firebase Storage upload...", "info");
            const posterRef = window.storage.ref(
              `test_events/${eventId}/poster.jpg`
            );
            const posterSnapshot = await posterRef.put(file);
            posterUrl = await posterSnapshot.ref.getDownloadURL();
            log("Firebase Storage upload successful!", "success");
          } catch (error) {
            log(`Firebase Storage failed: ${error.message}`, "warning");
            log("Falling back to base64 storage...", "info");

            // Fallback to base64
            posterUrl = await fileToBase64(file);
            log("Base64 conversion successful", "success");
          }

          // Create event in database
          const testEvent = {
            eventId: eventId,
            eventName: "CORS Test Event",
            organizerName: "Test Organizer",
            organizerEmail: "test@example.com",
            organizerPhone: "1234567890",
            typeOfOrganizer: "NGO",
            location: "Test Location",
            startDate: "2025-01-01",
            endDate: "2025-01-02",
            time: "10:00",
            registrationDeadline: "2024-12-31",
            description: "This is a CORS test event",
            clothTypes: ["Children"],
            posterUrl: posterUrl,
            proofImageUrl: "",
            createdAt: new Date().toISOString(),
            createdBy: window.auth.currentUser.uid,
          };

          await window.db.ref(`events/${eventId}`).set(testEvent);
          log("Event saved to database successfully", "success");

          // Clean up
          await window.db.ref(`events/${eventId}`).remove();
          log("Test event cleaned up", "success");

          resultDiv.innerHTML =
            '<span class="success">‚úÖ Test completed successfully! CORS fix is working.</span>';
        } catch (error) {
          log(`Test failed: ${error.message}`, "error");
          resultDiv.innerHTML = `<span class="error">‚ùå Test failed: ${error.message}</span>`;
        }
      }

      // Test event creation without file
      async function testEventWithoutFile() {
        const resultDiv = document.getElementById("testResult");

        if (!window.auth.currentUser) {
          log("Signing in anonymously...", "info");
          try {
            await window.auth.signInAnonymously();
            log("Anonymous sign in successful", "success");
          } catch (error) {
            log(`Sign in failed: ${error.message}`, "error");
            return;
          }
        }

        log("Starting event creation test without file...", "info");
        resultDiv.innerHTML =
          '<span class="warning">‚è≥ Creating event...</span>';

        try {
          const eventId = window.db.ref("events").push().key;
          log(`Generated event ID: ${eventId}`, "info");

          const testEvent = {
            eventId: eventId,
            eventName: "CORS Test Event (No File)",
            organizerName: "Test Organizer",
            organizerEmail: "test@example.com",
            organizerPhone: "1234567890",
            typeOfOrganizer: "NGO",
            location: "Test Location",
            startDate: "2025-01-01",
            endDate: "2025-01-02",
            time: "10:00",
            registrationDeadline: "2024-12-31",
            description: "This is a CORS test event without file",
            clothTypes: ["Children"],
            posterUrl: "",
            proofImageUrl: "",
            createdAt: new Date().toISOString(),
            createdBy: window.auth.currentUser.uid,
          };

          await window.db.ref(`events/${eventId}`).set(testEvent);
          log("Event saved to database successfully", "success");

          // Clean up
          await window.db.ref(`events/${eventId}`).remove();
          log("Test event cleaned up", "success");

          resultDiv.innerHTML =
            '<span class="success">‚úÖ Test completed successfully! Database operations work.</span>';
        } catch (error) {
          log(`Test failed: ${error.message}`, "error");
          resultDiv.innerHTML = `<span class="error">‚ùå Test failed: ${error.message}</span>`;
        }
      }

      // Helper function to convert file to base64
      function fileToBase64(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.readAsDataURL(file);
          reader.onload = () => resolve(reader.result);
          reader.onerror = (error) => reject(error);
        });
      }

      // Initialize
      window.addEventListener("load", function () {
        log("CORS test page loaded", "info");
        log("Ready to test event creation with CORS fix", "info");
      });
    </script>
  </body>
</html>
